# 集成两阶段切割（Stock → Strip → Item）Standard v1.1（中文版）

## 摘要
本文给出一种层级两阶段切割问题的标准化建模与求解模板：每张 stock（宽 `W`、长 `L`）先沿宽度方向切成若干条 **全长 strip**，再在每条 strip 上沿长度方向切成 items。我们采用一个 **集成主问题** 将第一阶段的 strip 供给与第二阶段的 strip 消耗耦合，并通过 **列生成（Column Generation）+ 分支定价（Branch-and-Price）** 求解。定价子问题为 knapsack，可用带 **loss arcs（显式 slack）** 的 arc-flow 形式实现，以保证与 `≤`-knapsack 的严格等价。我们明确给出 profit-form 与 reduced cost 的一致符号约定，并使用 **聚合弧使用量（aggregated arc usage）** 的分支规则，使分支约束能够通过对偶乘子自然进入定价。最后给出一个无需人工变量、对任意可行实例都能初始化可行的 RMP 构造。

**关键词**：两阶段切割；层级 guillotine；列生成；Branch-and-Price；knapsack 定价；arc-flow；聚合分支

---

## 0. 版本说明（相对 v1.0 的增补点）
本版本在不改变总体结构的前提下补齐以下严谨性条款：

1. **profit-form 与标准 reduced cost 的严格等价**：统一对偶变量与利润的定义，使得 `profit > 0 ⇔ reduced cost < 0` 成为严格等价关系。
2. **重复长度/重复尺寸下 arc-flow 的可识别性**：SP2 的弧必须按 item type 标记，避免“同长度不同 item type”被误合并导致列系数无法恢复。
3. **side trim 语义固定为“段级别（segment-level）一次修边”**：确保 SP2 只需长度 knapsack 即与物理含义一致。
4. **RMP 初始可行列集合的标准构造**：给出一个无需人工变量、对任意可行实例都可构造可行初解的 `(P0,Q0)` 及可行性证明思路。

---

## 1. 问题描述与假设

### 1.1 Stock 与 items
- Stock 尺寸为 `W × L`（width × length），`W,L ∈ Z_+`。
- Item type 集合为 `I`。每个 `i ∈ I` 尺寸为 `(w_i, l_i)`，需求为 `d_i ∈ Z_+`。
- 不允许旋转（rotation disallowed）。

### 1.2 两阶段切割层级
- Stage 1：在 stock 上沿 **宽度方向** 切出若干条 **全长 strips**（长度固定为 `L`）。
- Stage 2：每条 strip 再沿 **长度方向** 切成若干段，每段对应一个 item（长度为 `l_i`）。

### 1.3 Strip types 的定义（宽度集合）
令 strip type 集合
$$
J := \{w_i:\ i\in I\}\quad (\text{去重后})
$$
并将每个 `j ∈ J` 视为“宽度为 `w_j`”的一类 strip。

### 1.4 宽可行性与 side trim（本版本锁死的语义）
- **宽可行性**：item `i` 可在 strip type `j` 上生产当且仅当
$$
w_i \le w_j.
$$
- **side trim（段级别）**：当 `w_i < w_j` 时，允许对该 strip 上“被切出的该 item 长度段（segment）”进行 **一次纵向修边**，将宽度从 `w_j` 修到 `w_i`。修掉部分为 waste，**不可复用**。  
  该语义的直接后果是：**同一条 strip 上允许混合不同宽度的 items**（因为修边发生在各段上，而非整条 strip 全长一次修边），因此 Stage 2 的定价仅需长度 knapsack。

> 说明（替代语义不在本标准覆盖范围内）：  
> 若采用“整条 strip 只能纵向修边一次并贯穿全长”，则同一条 strip 基本只能生产同一宽度的 items（或需额外结构变量表示宽度切换），SP2 将不再是纯长度 knapsack。

### 1.5 宽可行 item 集
对每个 `j ∈ J`，定义
$$
I(j) := \{i\in I:\ w_i \le w_j\}.
$$

### 1.6 需求与余量策略
- 允许超产（overproduction allowed）：需求约束采用 `≥`。
- 允许 unused strips：strip 供给可大于 strip 消耗。

---

## 2. 列定义与集成主问题（Integrated Master）

### 2.1 列（patterns）与系数
- Stock patterns：集合 `Q`。对 `q ∈ Q`，
  $$
  C_{jq} \in Z_+,\ \forall j\in J
  $$
  表示 pattern `q` 在一张 stock 上切出多少条 type-`j` strip。
- Strip patterns：集合 `P`。对 `p ∈ P`，
  $$
  B_{ip} \in Z_+,\ \forall i\in I
  $$
  表示 pattern `p` 在一条 strip 上生产多少个 type-`i` item。
- Strip-type indicator：对 `p ∈ P`，
  $$
  A_{jp} \in \{0,1\},\ \forall j\in J
  $$
  且每个 strip pattern **恰好消耗一种 strip type**：存在唯一 `j(p) ∈ J` 使 `A_{j(p),p}=1`，其余为 0。

### 2.2 主问题变量
$$
Y_q \in Z_+,\ q\in Q:\ \text{使用 stock pattern }q\text{ 的次数}
$$
$$
X_p \in Z_+,\ p\in P:\ \text{使用 strip pattern }p\text{ 的次数（消耗 strip 的次数）}
$$

### 2.3 集成主问题（IP 形式）
$$
\min \sum_{q\in Q} Y_q
$$
s.t.
$$
\sum_{p\in P} B_{ip}X_p \ge d_i,\quad \forall i\in I,
$$
$$
\sum_{q\in Q} C_{jq}Y_q - \sum_{p\in P} A_{jp}X_p \ge 0,\quad \forall j\in J,
$$
$$
X_p\ge 0,\ Y_q\ge 0,\quad X_p,Y_q\in Z_+.
$$

列生成在 LP 松弛上运行（去掉整数性），整数性由 Branch-and-Price 强制。

---

## 3. 对偶变量与 profit-form：严格符号约定

### 3.1 核心约定（profit = − reduced cost）
对 LP 松弛，令
- `π_i ≥ 0` 对应 item 需求约束：
  $$
  \sum_{p} B_{ip}X_p \ge d_i
  $$
- `v_j ≥ 0` 对应 strip 平衡约束：
  $$
  \sum_{q} C_{jq}Y_q - \sum_{p} A_{jp}X_p \ge 0
  $$

本标准采用如下 **严格定义**：

- 对任意 strip 列 `p`，定义 profit
$$
\text{profit}_X(p) := \sum_{i\in I}\pi_i B_{ip} - \sum_{j\in J} v_j A_{jp}
= \sum_{i\in I}\pi_i B_{ip} - v_{j(p)}.
$$
- 对任意 stock 列 `q`，定义 profit
$$
\text{profit}_Y(q) := \sum_{j\in J} v_j C_{jq} - 1.
$$

并规定标准 reduced cost 满足
$$
\text{rc}_X(p) = -\text{profit}_X(p),\qquad
\text{rc}_Y(q) = -\text{profit}_Y(q).
$$
因此
$$
\text{profit} > 0 \Longleftrightarrow \text{reduced cost} < 0
$$
为严格等价。

### 3.2 列接受规则
给定容差 `ε_rc > 0`：若定价最优 profit `> ε_rc`，则加入相应列。

---

## 4. 定价子问题（Knapsack form）

### 4.1 SP2：固定 strip type `j` 的 strip 定价（Stage 2）
对固定 `j ∈ J`，求解
$$
\max \ \sum_{i\in I(j)} \pi_i D_i - v_j
$$
s.t.
$$
\sum_{i\in I(j)} l_i D_i \le L,\qquad D_i\in Z_+.
$$
若最优值 `> ε_rc`，生成新 strip 列 `p`，满足 `j(p)=j` 且 `B_{ip}=D_i`。

### 4.2 SP1：stock 定价（Stage 1）
求解
$$
\max \ \sum_{j\in J} v_j G_j - 1
$$
s.t.
$$
\sum_{j\in J} w_j G_j \le W,\qquad G_j\in Z_+.
$$
若最优值 `> ε_rc`，生成新 stock 列 `q`，满足 `C_{jq}=G_j`。

---

## 5. Arc-flow 定价（v1.1：重复长度严格版）

### 5.1 通用 arc-flow（必须包含 loss arcs）
给定容量 `C ∈ Z_+`，节点集 `V={0,1,...,C}`。定义 loss arcs
$$
A^{loss} := \{(t,t+1):t=0,\dots,C-1\},
$$
用于显式表示 slack，从而与 `≤`-knapsack 严格等价（避免被误建成“必须恰好填满”）。

### 5.2 v1.1 关键修订：SP2 的 item arcs 必须按 item type 标记
为避免不同 item type 共享同一长度 `l` 时发生歧义，SP2 的弧定义为带标签三元弧：
$$
A^{item}(j) := \{(t,\,t+l_i,\,i):\ i\in I(j),\ t+l_i\le L\}.
$$
对每条弧 `a=(t,t+l_i,i)` 设二元变量 `x_a ∈ {0,1}` 表示路径是否使用该弧（允许平行弧：同起点同终点但标签不同）。
则 item 计数严格恢复为
$$
D_i = \sum_{t=0}^{L-l_i} x_{(t,t+l_i,i)}.
$$
对应 SP2 的 arc-flow 目标（profit-form）为
$$
\max\ \sum_{i\in I(j)}\sum_{t=0}^{L-l_i} \pi_i\,x_{(t,t+l_i,i)}\ -\ v_j,
$$
loss arcs 的 reward 为 0。

### 5.3 SP1 的 arc-flow
SP1 可在 `V={0,...,W}` 上定义 item arcs `(t,t+w_j)` 与 loss arcs `(t,t+1)`，并用 reward `v_j` 构成 knapsack 定价。

---

## 6. Branch-and-Price：聚合弧使用量分支（兼容定价）

### 6.1 分支原则
分支必须施加在主问题变量 `(X,Y)` 的线性表达式上，而不是某次定价路径内部的弧二元变量上。

### 6.2 主分支：SP2 item arcs 的聚合使用量（排除 loss arcs）
对带标签 SP2 item arc
$$
a=(t,t+l_i,i),
$$
定义列-弧关联指示
$$
\delta^X_{a,p}=
\begin{cases}
1,& \text{若 strip 列 }p\text{ 的 SP2 路径使用弧 }a,\\
0,& \text{否则}.
\end{cases}
$$
聚合弧使用量定义为
$$
F^X_a := \sum_{p\in P:\ j(p)=j(a)} \delta^X_{a,p}X_p.
$$
若 LP 最优解中 `F_a^{X*}` 为分数，则分支：
$$
F^X_a \le \lfloor F_a^{X*}\rfloor\quad \text{vs.}\quad
F^X_a \ge \lceil F_a^{X*}\rceil.
$$

### 6.3 分支约束如何进入定价（dual-adjusted rewards）
每条继承下来的聚合弧使用量约束在节点 LP 上产生对偶乘子 `μ_a`。定价时可等价地通过调整对应弧的 reward 吸收该约束：
$$
\pi_i \mapsto \pi_i + \mu_{(t,t+l_i,i)}
$$
（仅对被约束弧），loss arcs reward 仍为 0。SP1 对应调整 `v_j` 的弧 reward。

---

## 7. RMP 初始化：一个“永远可行”的标准构造（无需人工变量）

### 7.1 实例可行性最弱前提
为保证存在可行解，至少需要：
- `∀i ∈ I: l_i ≤ L`（否则 item 长度放不进任何 strip）；
- `∀j ∈ J: w_j ≤ W`（否则该 strip 宽度放不进 stock）。

### 7.2 初始化列集合 `(P0,Q0)`
**(A) 初始 stock 列：对每个 `j ∈ J`**  
构造 stock pattern `q^(j)`，只切出 1 条 type-`j` strip，其余宽度作为 waste：
$$
C_{j\,q^{(j)}}=1,\quad C_{j'\,q^{(j)}}=0\ (j'\neq j).
$$
令
$$
Q_0 := \{q^{(j)}:j\in J\}.
$$

**(B) 初始 strip 列：对每个 `i ∈ I`**  
构造 strip pattern `p^(i)`，消耗 strip type `j=w_i`，只生产 1 个 item `i`，其余长度作为 waste：
$$
j(p^{(i)})=w_i,\quad B_{i\,p^{(i)}}=1,\quad B_{i'\,p^{(i)}}=0\ (i'\neq i).
$$
令
$$
P_0 := \{p^{(i)}:i\in I\}.
$$

### 7.3 可行解的显式构造
令
$$
X_{p^{(i)}} := d_i \quad (\forall i\in I),
$$
并对每个 `j ∈ J`，令
$$
Y_{q^{(j)}} := \sum_{i\in I:\ w_i=w_j} d_i.
$$
则：
- 对每个 `i`，需求约束满足：`∑_p B_{ip}X_p ≥ d_i`；
- 对每个 `j`，strip 平衡满足（可取等号）：供给条数等于消耗条数。  
因此 RMP 在 `(P0,Q0)` 下可行。

---

## 8. 算法流程（Root CG + B\&P）
1. **初始化**：构造 `(P0,Q0)` 并解 RMP 的 LP 松弛。
2. **定价循环**：读取对偶 `(π,v)`，对所有 `j` 解 SP2，并解一次 SP1；加入所有 `profit > ε_rc` 的列，重新优化；直至无改进列。
3. **分支**：若节点 LP 在某个 `F_a^X` 上为分数，则按聚合弧使用量规则分支；对子节点重复“节点级列生成 + 继承分支约束”。

---
