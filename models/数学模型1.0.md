# 两阶段切割（Stock → Strip → Item）集成模型与 Branch-and-Price 标准文档（严谨版）

> 本文档给出可直接用于论文与实现的标准化数学版本：问题定义、符号、集成主问题（Master / RMP）、两类定价子问题（SP1/SP2）、Arc-Flow 的严格等价建模（显式 slack）、以及数学上自洽的 Branch-and-Price（在主问题对“弧聚合使用量”分支，并通过对偶价进入定价）。
>
> 已固定口径：
> - 条带候选宽度 **只取子板宽度集合**：$\mathcal J=\{w_i: i\in\mathcal I\}$（去重后）。
> - 宽度规则默认 **$w_i\le w_j$**，并明确物理含义：允许对切下的长度段做一次纵向修边（side trim），余量作为废料且不回收。
> - 不允许旋转。
> - 允许超产与多余条带（需求与条带平衡均为“$\ge$”）。
> - Arc-Flow 定价采用 **loss arcs** 表示 slack，保证与“$\le$”背包严格等价。
> - 分支主策略：对 **SP2 物品弧**做“弧聚合使用量分支”，备用分支为 SP1 物品弧，兜底分支为变量分支。
> - 数值阈值：$\varepsilon_{\text{int}}=10^{-6}$，$\varepsilon_{\text{rc}}=10^{-7}$。

---

## 1. 问题定义与物理假设

给定统一尺寸母板（stock）$W\times L$。需切割得到若干类子板（item），每类 $i\in\mathcal I$ 的尺寸为 $(w_i,l_i)$，需求量为 $d_i$。

切割采用两层结构：

- **阶段 1（Stock → Strips）**：从母板切出若干条带（strip），每条带长度固定为 $L$，宽度为某一条带类型 $j\in\mathcal J$ 的宽度 $w_j$。母板剩余宽度为废料。
- **阶段 2（Strips → Items）**：在条带上沿长度方向切割产生子板。默认允许 **$w_i\le w_j$**：
  - $w_i=w_j$：切出的长度段直接为子板；
  - $w_i<w_j$：对该段允许做一次纵向修边（side trim），侧向余量 $w_j-w_i$ 视为废料且不回收利用。

目标：最小化使用母板数量（母板单位成本为 1）。

---

## 2. 符号与口径

### 2.1 集合与参数

- 子板类型集合：$\mathcal I$，索引 $i$
- 条带类型集合：$\mathcal J$，索引 $j$
- 母板尺寸：宽 $W$，长 $L$
- 子板 $i$：宽 $w_i$，长 $l_i$，需求 $d_i$

### 2.2 条带类型集合（已固定）

条带候选宽度只取子板宽度集合（去重）：
$$
\mathcal J=\{w_i: i\in\mathcal I\}.
$$
若存在多个子板宽度相同，则对应同一条带类型。

记条带类型 $j$ 的宽度为 $w_j$（因此 $w_j$ 取自某些 $w_i$）。

### 2.3 宽度可行性集合（已固定）

对每个条带类型 $j$，允许切割的子板集合为：
$$
\mathcal I(j)=\{\,i\in\mathcal I:\ w_i\le w_j\,\}.
$$

---

## 3. 列（模式）结构与基本假设

采用列生成。主问题显式维护有限列集合：

- **Stock 模式（母板模式）**：$q\in\mathcal Q$  
  $$
  C_{jq}\in\mathbb Z_+:\ \text{模式 }q\text{ 在一张母板上产生的 }j\text{ 类条带数量。}
  $$

- **Strip 模式（条带模式）**：$p\in\mathcal P$  
  $$
  B_{ip}\in\mathbb Z_+:\ \text{模式 }p\text{ 在一条条带上产生的 }i\text{ 类子板数量。}
  $$
  $$
  A_{jp}\in\{0,1\}:\ \text{模式 }p\text{ 消耗的条带类型标记。}
  $$

**假设 1（条带模式绑定唯一条带类型）**  
每个条带模式 $p$ 恰消耗一种条带类型，存在唯一 $j(p)\in\mathcal J$ 使得：
$$
A_{j(p)p}=1,\qquad A_{jp}=0\ \ (\forall j\ne j(p)).
$$
因此每个 $p$ 可视为“属于条带类型 $j(p)$”的模式。

---

## 4. 集成主问题（Master Problem）

### 4.1 变量

- $Y_q\in\mathbb Z_+$：使用 stock 模式 $q$ 的次数（母板用量）
- $X_p\in\mathbb Z_+$：使用 strip 模式 $p$ 的次数（条带消耗次数）

### 4.2 整数主问题（IP）

$$
\min\ \sum_{q\in\mathcal Q} Y_q
$$

s.t.

**(D) 需求满足（允许超产）**
$$
\sum_{p\in\mathcal P} B_{ip}X_p \ \ge\ d_i,\qquad \forall i\in\mathcal I
$$

**(S) 条带平衡（允许多余条带）**
$$
\sum_{q\in\mathcal Q} C_{jq}Y_q\ -\ \sum_{p\in\mathcal P} A_{jp}X_p \ \ge\ 0,\qquad \forall j\in\mathcal J
$$

$$
X_p\in\mathbb Z_+,\qquad Y_q\in\mathbb Z_+.
$$

### 4.3 受限主问题（RMP）与 LP 松弛

列生成中对有限列集合求解 LP 松弛：
$$
X_p\ge 0,\qquad Y_q\ge 0.
$$

---

## 5. 对偶与利润式 reduced cost（入列判据）

对 RMP（LP）引入对偶变量：

- 对需求约束 (D)：$\pi_i\ge 0$，$\forall i\in\mathcal I$
- 对条带平衡约束 (S)：$v_j\ge 0$，$\forall j\in\mathcal J$

对任意候选列，采用“利润式”入列判据（将经典 reduced cost 取负号）：

- **条带列（Strip 列）$p$** 的利润：
$$
RC_X(p)=\sum_{i\in\mathcal I}\pi_i B_{ip}\ -\ \sum_{j\in\mathcal J} v_j A_{jp}
=\sum_{i}\pi_i B_{ip}-v_{j(p)}.
$$
若 $RC_X(p)>\varepsilon_{\text{rc}}$ 则加入该列。

- **母板列（Stock 列）$q$** 的利润：
$$
RC_Y(q)=\sum_{j\in\mathcal J} v_j C_{jq}\ -\ 1.
$$
若 $RC_Y(q)>\varepsilon_{\text{rc}}$ 则加入该列。

**终止条件（节点内列生成）**  
当所有定价问题最优利润均满足 $\max RC \le \varepsilon_{\text{rc}}$ 时，该节点 RMP（LP）达到最优，停止列生成。

---

## 6. 两类定价子问题（SP1 / SP2）的整数背包形式

### 6.1 SP2（固定条带类型 $j$：生成 strip 列）

对固定 $j$，求解长度背包：
$$
\max\ \sum_{i\in\mathcal I(j)} \pi_i D_i\ -\ v_j
$$
s.t.
$$
\sum_{i\in\mathcal I(j)} l_i D_i\ \le\ L,\qquad D_i\in\mathbb Z_+.
$$

若最优值 $>\varepsilon_{\text{rc}}$，则生成新 strip 列 $p$：令 $j(p)=j$，并取 $B_{ip}=D_i$。

### 6.2 SP1（生成 stock 列）

求解宽度背包：
$$
\max\ \sum_{j\in\mathcal J} v_j G_j\ -\ 1
$$
s.t.
$$
\sum_{j\in\mathcal J} w_j G_j\ \le\ W,\qquad G_j\in\mathbb Z_+.
$$

若最优值 $>\varepsilon_{\text{rc}}$，则生成新 stock 列 $q$：取 $C_{jq}=G_j$。

---

## 7. Arc-Flow 定价（严格等价于“$\le$”背包）

### 7.1 关键原则：必须显式建模 slack

若用“0→终点的单位流路径”刻画装载，但网络中没有 slack（空走/损耗）结构，则会将“$\le$”背包误收紧为 exact fill。本文采用 **loss arcs**，保证 Arc-Flow 与背包可行域严格等价。

### 7.2 通用 Arc-Flow 模板（loss arcs）

给定容量 $C\in\mathbb Z_+$，构造 DAG：

- 节点：$V=\{0,1,\dots,C\}$
- 物品弧：
$$
A^{\text{item}}=\{(t,t+s)\mid s\in\mathcal S,\ t+s\le C\}
$$
- 损耗弧（slack）：
$$
A^{\text{loss}}=\{(t,t+1)\mid t=0,\dots,C-1\}
$$
- 总弧集：$A=A^{\text{item}}\cup A^{\text{loss}}$

变量：对每条弧 $a\in A$，设 $x_a\in\{0,1\}$。

单路径（单位流）约束：
$$
\sum_{a\in\delta^+(0)}x_a=1,\qquad
\sum_{a\in\delta^-(C)}x_a=1,
$$
$$
\sum_{a\in\delta^-(n)}x_a=\sum_{a\in\delta^+(n)}x_a,\quad \forall n=1,\dots,C-1.
$$

目标（仅物品弧计收益，损耗弧收益为 0）：
$$
\max\ \sum_{a\in A^{\text{item}}}\theta(a)\,x_a.
$$

**命题 1（等价性）**  
上述 Arc-Flow 与整数背包 $\sum s_k z_k\le C,\ z_k\in\mathbb Z_+$ 在可实现装载集合上等价：未用容量由损耗弧表示。

### 7.3 SP1 的 Arc-Flow（容量 $C=W$）

- 物品尺寸集合：$\mathcal S=\{w_j: j\in\mathcal J\}$
- 物品弧 $(t,t+w_j)$ 的收益：$\theta=v_j$

目标（含常数项 $-1$）：
$$
\max\ \sum_{j\in\mathcal J}\sum_{t=0}^{W-w_j} v_j\,x_{t,t+w_j}\ -\ 1.
$$

由物品弧计数恢复：
$$
G_j=\sum_{t=0}^{W-w_j} x_{t,t+w_j}.
$$

### 7.4 SP2 的 Arc-Flow（容量 $C=L$，对每个 $j$ 独立）

对固定条带类型 $j$：

- 物品尺寸集合：$\mathcal S=\{l_i: i\in\mathcal I(j)\}$
- 物品弧 $(t,t+l_i)$ 的收益：$\theta=\pi_i$

目标（含常数项 $-v_j$）：
$$
\max\ \sum_{i\in\mathcal I(j)}\sum_{t=0}^{L-l_i} \pi_i\,x_{t,t+l_i}\ -\ v_j.
$$

由物品弧计数恢复：
$$
D_i=\sum_{t=0}^{L-l_i} x_{t,t+l_i},\qquad i\in\mathcal I(j).
$$

---

## 8. 根节点列生成（LP 下界）

给定初始列集合 $\mathcal P,\mathcal Q$ 使 RMP 可行，重复：

1. 解 RMP（LP），得到对偶 $\pi,v$；
2. 对每个 $j\in\mathcal J$ 解 SP2（Arc-Flow），若最优利润 $>\varepsilon_{\text{rc}}$，加入相应 strip 列；
3. 解 SP1（Arc-Flow），若最优利润 $>\varepsilon_{\text{rc}}$，加入相应 stock 列；
4. 若所有定价问题最优利润均 $\le \varepsilon_{\text{rc}}$，终止。

终止时得到根节点 LP 最优解与下界。

---

## 9. Branch-and-Price（严谨分支：主问题弧聚合分支 + 对偶进入定价）

若节点 $\mathcal N$ 的 LP 解非整数，则分支生成两个子节点；每个子节点上再次运行“带节点约束的列生成”至其 LP 最优。

### 9.1 分支对象必须在主问题层定义

分支约束必须作用于 $X,Y$ 的线性组合（主问题表达式），不能直接对定价子问题的 0/1 弧变量做 floor/ceil。

### 9.2 主分支：SP2 物品弧的“弧聚合使用量分支”

**弧—列指示量**  
对 SP2 的物品弧 $a=(t,t+l_i)$（其中 $i\in\mathcal I(j)$ 且 $j$ 为该网络对应条带类型），对每个 strip 列 $p$ 定义：
$$
\delta^X_{a,p}=
\begin{cases}
1,& \text{列 }p\text{ 的 SP2 路径使用弧 }a,\\
0,& \text{否则}.
\end{cases}
$$

**弧聚合使用量（主问题线性表达式）**
$$
F^X_a=\sum_{p\in\mathcal P:\ j(p)=j(a)} \delta^X_{a,p}\,X_p.
$$
若 $X$ 整数，则 $F^X_a$ 必为整数。

**分支规则（floor/ceil）**  
在节点 LP 解中，若选择弧 $a$ 使 $F^{X*}_a\notin\mathbb Z$，生成两个子节点：
- 左子节点：$\quad F^X_a \le \lfloor F^{X*}_a\rfloor$
- 右子节点：$\quad F^X_a \ge \lceil F^{X*}_a\rceil$
并将其作为该子节点 RMP 的新增行约束。
**候选弧集合与选择准则（可复现）**  
候选弧集合：
$$
\mathcal A^{\text{cand}}=\{a:\ \operatorname{frac}(F^{X*}_a)\in(\varepsilon_{\text{int}},\,1-\varepsilon_{\text{int}})\}.
$$
选择规则为按序最小化/最大化：
1) $|\operatorname{frac}(F^{X*}_a)-0.5|$ 最小；  
2) $|F^{X*}_a|$ 最大；  
3) 弧编号最小（作为固定 tie-break）。
**不分支弧的约束**  
不对损耗弧 $A^{\text{loss}}$ 分支。
### 9.3 备用分支：SP1 物品弧的弧聚合分支

当 SP2 上无可分支弧或推进不足时，可对 SP1 物品弧 $a=(t,t+w_j)$ 定义：
$$
\delta^Y_{a,q}\in\{0,1\},\qquad
F^Y_a=\sum_{q\in\mathcal Q}\delta^Y_{a,q}\,Y_q,
$$
并同样执行 floor/ceil 分支。

### 9.4 兜底分支：变量分支（保证不陷入“无分支点”）

若在 SP2 与 SP1 上都无法找到满足阈值的分数弧，则选择最分数的主问题变量进行分支：

- 优先选择 $X_p$，否则选择 $Y_q$：
$$
X_p \le \lfloor X_p^*\rfloor\ \text{ / }\ X_p \ge \lceil X_p^*\rceil,
\quad\text{或}\quad
Y_q \le \lfloor Y_q^*\rfloor\ \text{ / }\ Y_q \ge \lceil Y_q^*\rceil.
$$

### 9.5 节点约束如何进入定价：对偶价修正弧收益

在节点 $\mathcal N$ 的 RMP 中，所有继承的弧分支约束（含本节点新增）作为行约束存在，产生相应对偶价 $\mu_a$。

对任意候选 strip 列 $p$，其对新增弧约束的系数为 $\delta^X_{a,p}$，因此 reduced cost 的利润式表达将额外包含
$$
\sum_{a\in\mathcal A_\mathcal N} \mu_a\,\delta^X_{a,p}.
$$

在 SP2 Arc-Flow 定价中，这等价于对受约束的物品弧 $a=(t,t+l_i)$ 进行系数修正：
$$
\pi_i\ \mapsto\ \pi_i+\mu_a,
$$
损耗弧仍为 0。SP1 同理对弧 $(t,t+w_j)$ 修正 $v_j\mapsto v_j+\mu_a$。

定价后仍采用入列判据：若最优利润 $>\varepsilon_{\text{rc}}$ 则加入新列。

---

## 10. 数值容差与终止准则（已固定）

- 整数判别阈值：$\varepsilon_{\text{int}}=10^{-6}$  
  $$
  \text{integer}(x)\iff |x-\mathrm{round}(x)|\le \varepsilon_{\text{int}}.
  $$

- 入列阈值（利润式）：$\varepsilon_{\text{rc}}=10^{-7}$  
  仅当定价最优利润 $RC>\varepsilon_{\text{rc}}$ 才加入列。

- 节点内列生成终止：所有定价问题最优利润均满足 $\max RC \le \varepsilon_{\text{rc}}$。

---

## 11. 解的解释与方案恢复

当 Branch-and-Price 得到整数解 $(X,Y)$：

- 每个 $Y_q$ 表示母板模式 $q$ 使用 $Y_q$ 次：阶段 1 产生条带 $C_{jq}$；
- 每个 $X_p$ 表示条带模式 $p$ 使用 $X_p$ 次：阶段 2 消耗 $X_p$ 条 $j(p)$ 类条带并产生子板 $B_{ip}$；
- 约束 (S) 保证条带供给覆盖消耗；(D) 保证需求满足且允许超产；
- 若 $w_i<w_j$，每个切下段在宽度方向修边余量视为废料。

---

## 12. 可选简化（严格两阶段正交切割）

若希望阶段 2 仅沿长度切割、无侧向修边，则将宽度可行集改为：
$$
\mathcal I(j)=\{i\in\mathcal I:\ w_i=w_j\},
$$
其余模型、定价与分支框架保持不变。

---
