# CS-2D-BP-Arc 稳定性测试报告

**测试日期**: 2025-12-28
**测试人员**: Claude Code
**测试版本**: CS-2D-BP-Arc (Branch and Price with Arc Flow)

---

## 1. 测试目的

验证 CS-2D-BP-Arc 求解器在不同规模和难度的算例下能否稳定运行，评估其鲁棒性和适用范围。

---

## 2. 测试环境

### 2.1 硬件环境
- **操作系统**: Windows (WSL2 Linux 6.6.87.2)
- **平台**: x64

### 2.2 软件环境
- **编译器**: MSVC (Visual Studio 2022 Community)
- **构建系统**: CMake
- **优化求解器**: IBM CPLEX 22.1.0
- **CPLEX路径**: `D:/CPLEX/cplex/bin/x64_win64`

### 2.3 数据生成器
- **工具**: CS-2D-Data
- **数据格式**: OR标准CSV格式
- **字段定义**:
  - `stock_width`: 母板宽度 W (Stage1切割方向)
  - `stock_length`: 母板长度 L (Stage2切割方向)
  - `id, width, length, demand`: 子板编号、宽度、长度、需求量

---

## 3. 测试用例

### 3.1 测试用例1: 最小算例 (手工构造)

**文件**: `inst_test_minimal.csv`

**算例参数**:
| 参数 | 值 |
|------|-----|
| 母板尺寸 | W=100 x L=200 |
| 子板类型数 | 2 |
| 条带类型数 | 1 |
| 总需求量 | 4 |

**子板数据**:
| ID | 宽度 | 长度 | 需求 |
|----|------|------|------|
| 0 | 50 | 100 | 2 |
| 1 | 50 | 80 | 2 |

**测试结果**: 通过

**运行日志摘要**:
```
[2025-12-28 08:31:15.646] [数据] 母板尺寸: W=100 x L=200
[2025-12-28 08:31:15.646] [数据] 子板类型数: 2
[2025-12-28 08:31:15.646] [数据] 条带类型数: 1
[2025-12-28 08:31:15.646] [启发式] 生成初始解
[2025-12-28 08:31:15.646]   生成Y列数: 1
[2025-12-28 08:31:15.646]   生成X列数: 2
...
[2025-12-28 08:31:15.785] [CG] 列生成收敛, 迭代4次
[2025-12-28 08:31:15.786] [MP] 最终目标值: 1.0000
[2025-12-28 08:31:15.786] [结果] 根节点解为整数解, 无需分支
```

**性能指标**:
| 指标 | 值 |
|------|-----|
| 最优目标值 | 1.0000 |
| 列生成迭代次数 | 4 |
| 总耗时 | 0.152 秒 |
| 分支节点数 | 1 |

**最优解详情**:
```
X2 (条带1) = 1 [0, 1]
X3 (条带1) = 1 [2, 0]
X4 (条带1) = 1 [0, 2]
```

---

### 3.2 测试用例2: 简单生成算例 (d=0.05)

**文件**: `inst_20251228_083107_d0.05.csv`

**算例参数**:
| 参数 | 值 |
|------|-----|
| 母板尺寸 | W=100 x L=200 |
| 难度系数 | 0.05 |
| 已知最优解 | 6 |
| 子板类型数 | 6 |
| 条带类型数 | 6 |
| 总需求量 | 96 |

**子板数据**:
| ID | 宽度 | 长度 | 需求 |
|----|------|------|------|
| 0 | 15 | 60 | 9 |
| 1 | 16 | 45 | 24 |
| 2 | 17 | 53 | 6 |
| 3 | 19 | 55 | 18 |
| 4 | 30 | 41 | 24 |
| 5 | 32 | 34 | 15 |

**测试结果**: 失败 (Exit code 9)

**运行日志摘要**:
```
[2025-12-28 08:31:44.734] [数据] 母板尺寸: W=100 x L=200
[2025-12-28 08:31:44.734] [数据] 子板类型数: 6
[2025-12-28 08:31:44.734] [数据] 条带类型数: 6
[2025-12-28 08:31:44.734] [启发式] 生成初始解
[2025-12-28 08:31:44.734]   生成Y列数: 6
[2025-12-28 08:31:44.734]   生成X列数: 6
...
[2025-12-28 08:31:44.936] [MP-7] 更新并求解主问题
[2025-12-28 08:31:44.936] [MP] 目标值: 22.5500
[2025-12-28 08:31:44.937] [SP1-8] 节点1 求解SP1 (背包)
[2025-12-28 08:31:44.972]   [SP1] Reduced Cost: 1.0833
[2025-12-28 08:31:44.972]   [SP1] 找到改进列
[2025-12-28 08:31:44.973] [MP-8] 更新并求解主问题
[2025-12-  <-- 日志在此处截断，程序崩溃
```

**目标值演进**:
| 迭代 | 目标值 | Reduced Cost |
|------|--------|--------------|
| MP-0 | 96.0000 | - |
| MP-1 | 88.5000 | 6.0000 |
| MP-2 | 68.5000 | 6.0000 |
| MP-3 | 63.5000 | 5.1667 |
| MP-4 | 49.1000 | 5.0000 |
| MP-5 | 34.1000 | 3.0000 |
| MP-6 | 23.1000 | 3.0000 |
| MP-7 | 22.5500 | 1.0667 |
| MP-8 | 崩溃 | 1.0833 |

---

## 4. 问题分析

### 4.1 崩溃模式识别

通过对比成功和失败的测试用例，识别出以下崩溃模式:

| 特征 | 成功用例 | 失败用例 |
|------|----------|----------|
| 条带类型数 | 1 | 6 |
| 子板类型数 | 2 | 6 |
| 总需求量 | 4 | 96 |
| Y列数 | 1 | 6 |
| X列数 | 2 | 6 |

**关键发现**: 当条带类型数 > 1 时，求解器在列生成迭代7-8次后崩溃。

### 4.2 崩溃位置定位

**崩溃函数**: `SolveRootUpdateMP()` (src/root_node.cpp:312-337)

**崩溃代码段**:
```cpp
// 求解更新后的主问题
LOG_FMT("[MP-%d] 更新并求解主问题\n", node.iter_);
IloCplex cplex(env);
cplex.extract(model);
cplex.setOut(env.getNullStream());
bool feasible = cplex.solve();  // <-- 崩溃发生在此处或之后
```

**崩溃时机**: 在第8次主问题更新时，`cplex.solve()` 调用期间或之后立即崩溃。

### 4.3 可能原因分析

1. **CPLEX内存管理问题**
   - 每次迭代创建新的 `IloCplex` 对象可能导致内存泄漏
   - 列数量增长后，模型提取 (`cplex.extract`) 可能失败

2. **栈溢出**
   - 递归深度或局部变量过多
   - 大规模稀疏矩阵操作

3. **多条带类型SP2定价循环**
   - 当条带类型数增加时，SP2循环复杂度增加
   - 可能存在未初始化变量或越界访问

4. **数值稳定性**
   - 对偶变量精度问题
   - Reduced Cost 计算累积误差

---

## 5. 测试结论

### 5.1 稳定性评估

| 评估维度 | 结果 |
|----------|------|
| 单条带类型算例 | 稳定 |
| 多条带类型算例 | 不稳定 |
| 小规模算例 (n<=2) | 稳定 |
| 中等规模算例 (n>=6) | 不稳定 |

### 5.2 适用范围

**当前可用场景**:
- 所有子板宽度相同，形成单一条带类型
- 子板类型数 <= 2
- 总需求量较小

**当前不可用场景**:
- 多种条带类型 (子板宽度不同)
- 子板类型数 >= 6
- 实际生产规模算例

### 5.3 总体结论

**CS-2D-BP-Arc 目前无法在不同算例下稳定运行**。求解器仅对单条带类型的简单算例有效，对包含多条带类型的实际规模问题会在列生成第7-8次迭代时崩溃。

---

## 6. 建议修复方向

### 6.1 短期修复

1. **检查CPLEX对象生命周期**
   - 避免在循环中重复创建 `IloCplex` 对象
   - 使用单一 `IloCplex` 实例并重用

2. **添加异常处理**
   ```cpp
   try {
       bool feasible = cplex.solve();
   } catch (IloException& e) {
       LOG_FMT("[MP] CPLEX异常: %s\n", e.getMessage());
   }
   ```

3. **增加日志粒度**
   - 在 `cplex.solve()` 前后添加详细日志
   - 记录当前列数、约束数、变量数

### 6.2 中期优化

1. **内存管理审查**
   - 检查所有 `IloNumVarArray`、`IloRangeArray` 的释放
   - 使用智能指针或RAII模式

2. **数值稳定性增强**
   - 设置CPLEX数值精度参数
   - 添加Reduced Cost阈值检查

3. **分阶段测试**
   - 单独测试SP1子问题
   - 单独测试SP2子问题
   - 验证主问题模型正确性

### 6.3 长期改进

1. **重构列生成框架**
   - 参考成熟的列生成实现
   - 分离定价问题和主问题管理

2. **添加单元测试**
   - 为每个核心函数编写测试
   - 构建回归测试套件

---

## 附录

### A. 测试文件清单

| 文件路径 | 用途 |
|----------|------|
| `CS-2D-Data/data/inst_test_minimal.csv` | 最小测试算例 |
| `CS-2D-Data/data/inst_20251228_083107_d0.05.csv` | 生成算例 (d=0.05) |
| `CS-2D-BP-Arc/logs/log_2DBP_Arc_20251228_083115_645.log` | 成功运行日志 |
| `CS-2D-BP-Arc/logs/log_2DBP_Arc_20251228_083144_733.log` | 崩溃运行日志 |

### B. 相关源代码文件

| 文件 | 功能 |
|------|------|
| `src/root_node.cpp` | 根节点列生成主循环 |
| `src/root_node_sub.cpp` | 根节点子问题求解 (SP1, SP2) |
| `src/column_generation.cpp` | 列生成框架 |
| `src/input.cpp` | 数据读取和文件选择 |

### C. 命令行参考

**生成测试算例**:
```bash
./build/release/Release/CS-2D-Data.exe -d 0.05 -W 100 -L 200
```

**运行求解器**:
```bash
PATH="$PATH:/mnt/d/CPLEX/cplex/bin/x64_win64" ./build/release/bin/Release/CS-2D-BP-Arc.exe
```

---

*报告生成时间: 2025-12-28 08:35*
